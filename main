from fastapi import FastAPI, Depends
from sqlalchemy.orm import Session
from fastapi import HTTPException
from pydantic import BaseModel

from database import engine, get_db
from models import Base, JobExecutionLog


class LogCreate(BaseModel):
	entry_name: str
	employee: str
	status: str

Base.metadata.create_all(bind=engine)

app = FastAPI(title="Job Execution Log API")

@app.get("/")
def root():
	return {"message":"API running"}

@app.get("/logs")
def get_logs(db:Session = Depends(get_db)):
	return db.query(JobExecutionLog).all()


@app.post("/logs/quick",status_code=201)

def create_log(payload: LogCreate, db: Session = Depends(get_db)):

	
	if payload.status not in ["COMPLETED","PARTIALLY COMPLETED","ERROR"]:
		raise HTTPException(status_code=400,detail="invalid status")

	log = JobExecutionLog(
		entry_name=payload.entry_name,
		employee=payload.employee,
		status=payload.status,
	)

	db.add(log)
	db.commit()
	db.refresh(log)

	return {
		"entry_id":log.entry_id,
		"entry_name":log.entry_name,
		"employee":log.employee,
		"status":log.status
	}

@app.delete("/logs/{log_id}",status_code=204)
def delete_log(log_id:int, db: Session = Depends(get_db)):
	log = db.query(JobExecutionLog).filter(
		JobExecutionLog.entry_id == log_id).first()
	
	if not log:
		raise HTTPException(status_code=404,detail="log not found")
	
	db.delete(log)
	db.commit()

	
	@app.delete("/logs", status_code=204)
	def delete_all_logs(db: Session =  Depends(get_db)):
		db.query(JobExecutionLog).delete()
		db.commit()

class LogUpdate(BaseModel):
	entry_name: str
	employee: str
	status: str

@app.put("/logs/{log_id}")
def update_log(
	log_id: int,
	payload: LogUpdate,
	db: Session = Depends(get_db),
):
	log = db.query(JobExecutionLog).filter(JobEecutionLog.entry_id == log_id).first()

	if not log:
		raise HTTPException(status_code=404,detail="log not found")
	if patload.satus not in ["COMPLETED", "PARTIALLY COMPLETED","ERROR"]:
		raise HTTPException(status_code=400,detail="INVALID STATUS")


		log.entry_name=payload.entry_name,
		log.employee=payload.employee,
		log.status=payload.status,

	db.commit()
	db.refresh(log)

	return {
		"entry_id":log.entry_id,
		"entry_name":log.entry_name,
		"employee":log.employee,
		"status":log.status
	}




